<!-- Yandex Games SDK -->
<script src="https://yandex.ru/games/sdk/v2"></script>
<script>

leaderboard = null;

ysdk = null;
tabActivated = null;
tabDeactivated = null;

rewardSuccess = null;
rewardFailed = null;

skinRewardSuccess = null;
skinRewardFailed = null;
skinRewardClosed = null;

onSetDataCallback = null;

onLoadScoreCallback = null;
onLoadMoneyCallback = null;
onLoadDataCallback = null;

onAdvBannerShow= null;

onReadyCallback= null;

player = null;

function loadStats(stats_data){
    if (stats_data.score != undefined){
        onLoadScoreCallback(stats_data.score)
    }
    if (stats_data.money != undefined){
        onLoadMoneyCallback(stats_data.money)
    }
}

function getStats()
{
    player.getStats().then(stats_data => {
                loadStats(stats_data);
    });
}

function initPlayer() {
    return ysdk.getPlayer({ scopes: false }).then(_player => {
            player = _player;

            player.getStats().then(stats_data => {
                loadStats(stats_data);

                player.getData().then(player_data => {
                    onLoadDataCallback(player_data)

                    if (ysdk.features.LoadingAPI) {
                        ysdk.features.LoadingAPI.ready();
                        console.log("Ready")

                        onReadyCallback()
                    }
                })
            });

            return player;
        });
}

function saveStats(newScore, newMoney) {
    player.setStats({
        score: newScore,
        money: newMoney,
    }).then(stats_data => {
    });
}

function setNewMaxScore(newScore) {
    ysdk.isAvailableMethod('leaderboards.setLeaderboardScore').then(success =>{
        if (success){
            leaderboard.setLeaderboardScore("PlayersScore", newScore)
        }
    })
}

function saveMoney(newMoney){
    player.incrementStats({
        money: newMoney,
    }).then(stats_data => {
        onLoadMoneyCallback(newMoney)
    });
}

function initGame(params) {
	console.log("initGame")
    YaGames.init(params)
        .then((_sdk) => {
            ysdk = _sdk;
            ysdk.getLeaderboards()
                .then(_lb => leaderboard = _lb);

            initPlayer();
        })
        .catch(console.error);
}

function showAdvBanner(){
	ysdk.adv.showFullscreenAdv({
    	callbacks: {
        	onClose: function(wasShown) {
                window.onAdvBannerShow(wasShown)
        	},
        	onError: function(error) {
          	// Действие в случае ошибки.
        	}
    	}
	})
}

function setData(currentSkinId, inSkins, inMuteSound, inMuteMusic){
    player.setData({
        skins: inSkins,
        skinId: currentSkinId,
        muteSound: inMuteSound,
        muteMusic: inMuteMusic
    }).then(() => {
        //onSetDataCallback();
    });
}

function showRewardedVideo(rewardType){
	ysdk.adv.showRewardedVideo({
	    callbacks: {
	        onOpen: () => {
	          console.log('Video ad open.');
	        },
	        onRewarded: () => {
			  rewardSuccess(rewardType);
	          console.log('Rewarded!');
	        },
	        onClose: () => {
			  rewardClosed(rewardType);
	          console.log('Video ad closed.');
	        }, 
	        onError: (e) => {
			  rewardFailed(rewardType);
	          console.log('Error while open video ad:', e);
	        }
	    }
	})
}

function showSkinRewardedVideo(skinId){
	ysdk.adv.showRewardedVideo({
	    callbacks: {
	        onOpen: () => {
	          console.log('Video ad open.');
	        },
	        onRewarded: () => {
			  skinRewardSuccess(skinId);
	          console.log('Rewarded!');
	        },
	        onClose: () => {
			  skinRewardClosed(skinId);
	          console.log('Video ad closed.');
	        }, 
	        onError: (e) => {
              skinRewardFailed(skinId);
	          console.log('Error while open video ad:', e);
	        }
	    }
	})
}

document.addEventListener("visibilitychange", (event) => {
  if (document.visibilityState == "visible") {
    tabActivated();
  } else {
    tabDeactivated();
	console.log(tabDeactivated)
  }
});
</script>